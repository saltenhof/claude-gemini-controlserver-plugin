<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Session Pool — Test UI</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f23; color: #ccc; padding: 20px; }
        h1 { color: #4285f4; margin-bottom: 20px; font-size: 1.5em; }
        h2 { color: #8ab4f8; margin: 15px 0 10px; font-size: 1.1em; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; }
        .panel { background: #1a1a2e; border: 1px solid #333; border-radius: 8px; padding: 15px; }
        .slot { display: inline-block; padding: 8px 16px; margin: 4px; border-radius: 4px; font-size: 0.85em; }
        .slot-FREE { background: #1a472a; color: #4caf50; }
        .slot-BUSY { background: #4a3000; color: #ff9800; }
        .slot-ERROR { background: #4a0000; color: #f44336; }
        button { background: #4285f4; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin: 4px; }
        button:hover { background: #5a95f5; }
        button.danger { background: #d32f2f; }
        button.danger:hover { background: #e33e3e; }
        input, textarea { background: #16213e; color: #ccc; border: 1px solid #444; padding: 8px; border-radius: 4px; width: 100%; font-family: inherit; }
        textarea { min-height: 80px; resize: vertical; }
        .log { background: #0a0a1a; border: 1px solid #333; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.8em; white-space: pre-wrap; }
        .log-entry { margin: 2px 0; }
        .log-ok { color: #4caf50; }
        .log-err { color: #f44336; }
        .log-info { color: #8ab4f8; }
        label { display: block; margin: 8px 0 4px; color: #888; font-size: 0.85em; }
        .status-bar { display: flex; gap: 20px; margin-bottom: 15px; padding: 10px; background: #16213e; border-radius: 4px; }
        .status-item { font-size: 0.85em; }
        .status-value { color: #4285f4; font-weight: bold; }
        #response-area { background: #0a0a1a; border: 1px solid #333; border-radius: 4px; padding: 10px; max-height: 400px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85em; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Gemini Session Pool — Test UI</h1>

    <div class="status-bar" id="status-bar">
        <span class="status-item">Slots: <span class="status-value" id="st-slots">—</span></span>
        <span class="status-item">Free: <span class="status-value" id="st-free">—</span></span>
        <span class="status-item">Busy: <span class="status-value" id="st-busy">—</span></span>
        <span class="status-item">Error: <span class="status-value" id="st-error">—</span></span>
        <span class="status-item">Queue: <span class="status-value" id="st-queue">—</span></span>
        <span class="status-item">Chrome: <span class="status-value" id="st-chrome">—</span></span>
        <span class="status-item">Login: <span class="status-value" id="st-login">—</span></span>
        <span class="status-item">Uptime: <span class="status-value" id="st-uptime">—</span></span>
    </div>

    <div id="slots-display" style="margin-bottom: 15px;"></div>

    <div class="grid">
        <!-- Left: Acquire / Send / Release -->
        <div>
            <div class="panel">
                <h2>1. Acquire Slot</h2>
                <label>Owner:</label>
                <input type="text" id="owner" value="test-ui" placeholder="owner name">
                <button onclick="doAcquire()">Acquire</button>
                <div style="margin-top: 8px; font-size: 0.85em;">
                    Slot: <span id="cur-slot" style="color: #4285f4;">—</span> |
                    Token: <span id="cur-token" style="color: #4285f4;">—</span>
                </div>
            </div>

            <div class="panel" style="margin-top: 15px;">
                <h2>2. Send Message</h2>
                <label>Message:</label>
                <textarea id="message" placeholder="Enter your message for Gemini..."></textarea>
                <button onclick="doSend()">Send</button>
                <button onclick="doRelease()">Release Slot</button>
            </div>

            <div class="panel" style="margin-top: 15px;">
                <h2>Admin</h2>
                <button onclick="doPoolReset()" class="danger">Reset Pool</button>
                <button onclick="doSlotReset()">Reset Current Slot</button>
                <button onclick="doRefresh()">Refresh Status</button>
            </div>
        </div>

        <!-- Right: Response + Log -->
        <div>
            <div class="panel">
                <h2>Response</h2>
                <div id="response-area">Waiting for response...</div>
            </div>
            <div class="panel" style="margin-top: 15px;">
                <h2>Log</h2>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <script>
        const BASE = '';
        let slotId = null;
        let leaseToken = null;

        function log(msg, cls = 'log-info') {
            const el = document.getElementById('log');
            const ts = new Date().toLocaleTimeString();
            el.innerHTML += `<div class="log-entry ${cls}">[${ts}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function api(method, path, body = null, headers = {}) {
            const opts = { method, headers: { 'Content-Type': 'application/json', ...headers } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(BASE + path, opts);
            const data = await res.json();
            return { status: res.status, data };
        }

        async function doAcquire() {
            const owner = document.getElementById('owner').value || 'test-ui';
            log(`Acquiring slot for "${owner}"...`);
            try {
                const { status, data } = await api('POST', '/api/session/acquire', { owner });
                if (status === 200) {
                    slotId = data.slot_id;
                    leaseToken = data.lease_token;
                    document.getElementById('cur-slot').textContent = slotId;
                    document.getElementById('cur-token').textContent = leaseToken.substring(0, 8) + '...';
                    log(`Slot ${slotId} acquired${data.reattached ? ' (reattached)' : ''}`, 'log-ok');
                } else if (status === 202) {
                    log(`Queued at position ${data.queue_position} (wait ~${data.estimated_wait_s}s)`, 'log-info');
                } else {
                    log(`Rejected: ${data.error}`, 'log-err');
                }
            } catch (e) { log(`Error: ${e.message}`, 'log-err'); }
            doRefresh();
        }

        async function doSend() {
            if (slotId === null || !leaseToken) { log('No slot acquired!', 'log-err'); return; }
            const message = document.getElementById('message').value;
            if (!message) { log('No message!', 'log-err'); return; }
            log(`Sending to slot ${slotId}...`);
            document.getElementById('response-area').textContent = 'Waiting for Gemini response...';
            try {
                const { status, data } = await api('POST', `/api/session/${slotId}/send`,
                    { message }, { 'X-Lease-Token': leaseToken });
                if (status === 200) {
                    document.getElementById('response-area').textContent = data.response;
                    log(`Response received (${data.format}, ${data.duration_ms}ms)`, 'log-ok');
                } else {
                    document.getElementById('response-area').textContent = JSON.stringify(data, null, 2);
                    log(`Send failed: ${data.detail || data.error}`, 'log-err');
                }
            } catch (e) { log(`Error: ${e.message}`, 'log-err'); }
            doRefresh();
        }

        async function doRelease() {
            if (slotId === null || !leaseToken) { log('No slot to release!', 'log-err'); return; }
            log(`Releasing slot ${slotId}...`);
            try {
                await api('POST', `/api/session/${slotId}/release`, null, { 'X-Lease-Token': leaseToken });
                log(`Slot ${slotId} released`, 'log-ok');
                slotId = null; leaseToken = null;
                document.getElementById('cur-slot').textContent = '—';
                document.getElementById('cur-token').textContent = '—';
            } catch (e) { log(`Error: ${e.message}`, 'log-err'); }
            doRefresh();
        }

        async function doPoolReset() {
            if (!confirm('Reset entire pool? All sessions will be lost.')) return;
            log('Resetting pool...', 'log-err');
            try {
                const { data } = await api('POST', '/api/pool/reset');
                log(`Pool reset. ${data.slots_available} slots available.`, 'log-ok');
                slotId = null; leaseToken = null;
                document.getElementById('cur-slot').textContent = '—';
                document.getElementById('cur-token').textContent = '—';
            } catch (e) { log(`Error: ${e.message}`, 'log-err'); }
            doRefresh();
        }

        async function doSlotReset() {
            if (slotId === null) { log('No slot selected!', 'log-err'); return; }
            log(`Resetting slot ${slotId}...`);
            try {
                await api('POST', `/api/pool/slot/${slotId}/reset`);
                log(`Slot ${slotId} reset`, 'log-ok');
                slotId = null; leaseToken = null;
                document.getElementById('cur-slot').textContent = '—';
                document.getElementById('cur-token').textContent = '—';
            } catch (e) { log(`Error: ${e.message}`, 'log-err'); }
            doRefresh();
        }

        async function doRefresh() {
            try {
                const { data } = await api('GET', '/api/pool/status');
                document.getElementById('st-slots').textContent = data.total_slots;
                document.getElementById('st-free').textContent = data.free;
                document.getElementById('st-busy').textContent = data.busy;
                document.getElementById('st-error').textContent = data.error;
                document.getElementById('st-queue').textContent = data.queue_depth;
                document.getElementById('st-chrome').textContent = data.system.chrome;
                document.getElementById('st-login').textContent = data.system.login;
                document.getElementById('st-uptime').textContent = Math.floor(data.system.uptime_s) + 's';

                const slotsEl = document.getElementById('slots-display');
                slotsEl.innerHTML = data.slots.map(s => {
                    let label = `Slot ${s.id}: ${s.state}`;
                    if (s.state === 'BUSY') label += ` (${s.owner}, ${s.message_count} msgs)`;
                    return `<span class="slot slot-${s.state}">${label}</span>`;
                }).join('');
            } catch (e) { /* silent */ }
        }

        // Auto-refresh every 5 seconds
        setInterval(doRefresh, 5000);
        doRefresh();
    </script>
</body>
</html>
